<!doctype html>
<html lang="hi" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>बिहार मानसून डैशबोर्ड 2025</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "app-bg": "#F0F9FF",
              "dark-app-bg": "#030712",
              primary: "#2E8B57",
              secondary: "#E6F4EA",
              darkbg: "#1a202c",
              carddark: "#2d3748",
            },
          },
        },
      };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Tiro+Devanagari+Hindi&display=swap");

      body {
        font-family: "Poppins", "Tiro Devanagari Hindi", sans-serif;
        scroll-behavior: smooth;
      }

      .card {
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .dark .card {
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-track {
        background: #2d3748;
      }

      .nav-btn {
        @apply px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm hover:bg-green-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all select-none cursor-pointer;
      }

      /* --- Navbar Style --- */
      .navbar {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: fixed !important;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 1000 !important;
      }

      /* बॉडी को और नीचे धकेला गया है (Tiro Font के लिए) */
      body {
        padding-top: 180px !important; /* कंप्यूटर के लिए गैप बढ़ाया गया (2 rows) */
      }

      @media (max-width: 1023px) {
        body {
          padding-top: 220px !important; /* मोबाइल के लिए गैप बढ़ाया गया */
        }
      }

      /* हेडर का एडजस्टमेंट */
      #overview {
        padding-top: 0 !important;
        margin-top: -20px !important;
      }

      /* फ़ॉन्ट की ऊंचाई को संतुलित करने के लिए */
      h2,
      .gradient-text {
        line-height: 1.5 !important;
        padding-top: 5px;
      }

      .dark .navbar {
        background-color: rgba(30, 41, 59, 0.9) !important;
      }

      /* --- Gradient Text (for numbers/labels) --- */
      .gradient-text {
        background: linear-gradient(to right, #2563eb, #0d9488);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: inline-block;
      }
      .dark .gradient-text {
        background: linear-gradient(to right, #60a5fa, #2dd4bf);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: inline-block;
      }

      /* --- Nav Box Style --- */
      .nav-box {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid transparent;
        color: #4b5563;
        min-width: 110px;
        text-align: center;
        display: inline-block;
      }
      .dark .nav-box {
        color: #d1d5db;
      }
      .nav-box:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
        background-color: white;
      }
      .dark .nav-box:hover {
        background-color: #374151;
      }
      .nav-box.active-nav {
        background: linear-gradient(to right, #2563eb, #0d9488);
        color: white !important;
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        border: none;
      }

      .nav-links-container {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      @media (max-width: 1023px) {
        .nav-links-container {
          gap: 0.5rem;
          overflow-x: auto;
          white-space: nowrap;
          padding-bottom: 4px;
          flex-grow: 1;
          justify-content: flex-start;
        }
      }

      /* --- GLOWING CHART EFFECT (Updated for Teal Green) --- */
      /* Target the Actual Line (Sky Blue) */
      #comparisonChart .trace:nth-of-type(1) path.js-line {
        filter: drop-shadow(
          0 0 4px rgba(66, 165, 245, 0.7)
        ); /* Soft Blue Glow */
      }
      /* Target the Normal Line (Muted Red) */
      #comparisonChart .trace:nth-of-type(2) path.js-line {
        filter: drop-shadow(0 0 4px rgba(239, 83, 80, 0.7)); /* Soft Red Glow */
      }
      /* Target the Departure Line (Teal Green) */
      #comparisonChart .trace:nth-of-type(3) path.js-line {
        filter: drop-shadow(
          0 0 4px rgba(0, 188, 212, 0.8)
        ); /* Soft Cyan/Teal Glow */
      }

      /* --- Custom Color Scheme Variables --- */
      :root {
        /* User's specified colors for rainfall categories */
        --no-rain: #ffffff; /* white (NO RAIN: -100%) */
        --large-def: #ffd700; /* yellow (LARGE DEFICIENT: -60% to -99%) */
        --def: #e53935; /* red (DEFICIENT: -20% to -59%) */
        --normal: #4caf50; /* green (NORMAL: -19% to +19%) */
        --excess: #4fc3f7; /* light blue (EXCESS: +20% to +59%) */
        --large-excess: #1565c0; /* dark blue (LARGE EXCESS: +60% and above) */
      }

      /* =====================================================
           Plotly Modebar – Graph ke upar single horizontal line
           (Chat GPT Solution Applied)
           ===================================================== */
      /* Graph wrapper */
      .plotly-container {
        position: relative;
        padding-top: 46px; /* modebar ke liye jagah */
      }

      /* Modebar positioning */
      .plotly .modebar {
        position: absolute !important;
        top: 0 !important;
        right: 12px !important;

        display: flex !important;
        flex-direction: row !important;

        background: rgba(255, 255, 255, 0.95);
        padding: 4px 8px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 50;
      }

      /* Buttons spacing */
      .plotly .modebar-btn {
        margin: 0 4px !important;
      }

      /* Hover par hi visible ho */
      .plotly .modebar {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }
      .plotly-container:hover .modebar {
        opacity: 1;
      }

      /* Dark mode friendly (agar dark theme use hota ho) */
      .dark .plotly .modebar {
        background: rgba(30, 41, 59, 0.95);
      }

      /* Language Switcher Styles */
      .lang-switcher {
        position: relative;
        display: inline-block;
      }

      .lang-switcher button {
        background: linear-gradient(to right, #2563eb, #0d9488);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .lang-switcher button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      /* Language specific elements - Default to Hindi */
      .lang-en {
        display: none !important;
      }
      .lang-hi {
        display: block !important;
      }

      body.english .lang-en {
        display: block !important;
      }
      body.english .lang-hi {
        display: none !important;
      }

      /* Combined selection box */
      .combined-select-box {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 1px solid #cbd5e1;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .dark .combined-select-box {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        border-color: #4b5563;
      }

      /* Max/Min Rainfall Display Box */
      .max-min-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .dark .max-min-box {
        background: linear-gradient(135deg, #451a03 0%, #78350f 100%);
        border-color: #f59e0b;
      }

      .max-rain {
        color: #dc2626;
        font-weight: bold;
      }

      .min-rain {
        color: #2563eb;
        font-weight: bold;
      }

      /* --- Weather Background Animation --- */
      /* Body Background (Day Mode) */
      body {
        /* Animated Blue Sky Gradient */
        background: linear-gradient(-45deg, #87ceeb, #00bfff, #1e90ff, #87cefa);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        background-attachment: fixed;
        min-height: 100vh;
        margin: 0;
      }

      @keyframes gradientBG {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* Weather Background Container */
      .weather-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        pointer-events: none;
      }

      /* Sun & Clouds (Day Elements) */
      .sun {
        position: absolute;
        top: -60px;
        right: -60px;
        width: 250px;
        height: 250px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 220, 0.6) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        border-radius: 50%;
        filter: blur(30px);
        animation: sun-pulse 8s infinite alternate;
        transition:
          opacity 1s ease,
          transform 1s ease;
      }

      .cloud {
        position: absolute;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 50px;
        filter: blur(8px);
        transition: opacity 1s ease;
      }

      .cloud::after,
      .cloud::before {
        content: "";
        position: absolute;
        background: inherit;
        border-radius: 50%;
      }

      .cloud1 {
        width: 140px;
        height: 50px;
        top: 10%;
        left: -160px;
        animation: float-cloud 35s infinite linear;
      }
      .cloud1::after {
        width: 60px;
        height: 60px;
        top: -30px;
        left: 25px;
      }
      .cloud1::before {
        width: 50px;
        height: 50px;
        top: -20px;
        left: 70px;
      }

      .cloud2 {
        width: 100px;
        height: 40px;
        top: 25%;
        left: -120px;
        animation: float-cloud 45s infinite linear 12s;
      }
      .cloud2::after {
        width: 45px;
        height: 45px;
        top: -25px;
        left: 15px;
      }
      .cloud2::before {
        width: 40px;
        height: 40px;
        top: -15px;
        left: 50px;
      }

      .cloud3 {
        width: 180px;
        height: 60px;
        top: 15%;
        left: -200px;
        animation: float-cloud 50s infinite linear 5s;
      }
      .cloud3::after {
        width: 80px;
        height: 80px;
        top: -40px;
        left: 30px;
      }
      .cloud3::before {
        width: 60px;
        height: 60px;
        top: -25px;
        left: 90px;
      }

      @keyframes float-cloud {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(120vw);
        }
      }

      @keyframes sun-pulse {
        0% {
          transform: scale(1);
          opacity: 0.5;
        }
        100% {
          transform: scale(1.1);
          opacity: 0.7;
        }
      }

      /* Moon & Stars (Night Elements) */
      .moon {
        position: absolute;
        top: 60px;
        right: 80px;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        box-shadow: -20px 10px 0 0 #f6e58d;
        opacity: 0;
        transform: translateY(-50px) rotate(-20deg);
        transition: all 1s ease;
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 1s ease;
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
      }

      .star1 {
        width: 3px;
        height: 3px;
        top: 15%;
        left: 10%;
        animation-delay: 0s;
      }
      .star2 {
        width: 4px;
        height: 4px;
        top: 25%;
        left: 30%;
        animation-delay: 1s;
      }
      .star3 {
        width: 2px;
        height: 2px;
        top: 10%;
        left: 50%;
        animation-delay: 2s;
      }
      .star4 {
        width: 3px;
        height: 3px;
        top: 35%;
        left: 70%;
        animation-delay: 0.5s;
      }
      .star5 {
        width: 4px;
        height: 4px;
        top: 20%;
        left: 85%;
        animation-delay: 1.5s;
      }
      .star6 {
        width: 2px;
        height: 2px;
        top: 45%;
        left: 20%;
        animation-delay: 2.5s;
      }
      .star7 {
        width: 3px;
        height: 3px;
        top: 5%;
        left: 60%;
        animation-delay: 0.8s;
      }

      /* Dark Mode Styles (Night Theme) */
      .dark body {
        background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364, #000000);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
      }

      /* Hide Sun/Clouds and Show Moon/Stars in Dark Mode */
      .dark .sun {
        opacity: 0;
        transform: translateY(50px);
      }
      .dark .cloud {
        opacity: 0;
      }
      .dark .moon {
        opacity: 1;
        transform: translateY(0) rotate(-20deg);
      }
      .dark .star {
        animation: twinkle 3s infinite ease-in-out;
        opacity: 1;
      }

      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.2;
          transform: scale(0.8);
        }
        50% {
          opacity: 1;
          transform: scale(1.2);
        }
      }

      /* --- New Language Toggle Switch --- */
      .lang-switch-wrapper {
        display: flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.6);
        padding: 4px 8px;
        border-radius: 20px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(4px);
      }
      .dark .lang-switch-wrapper {
        background: rgba(30, 41, 59, 0.6);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .lang-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: #64748b;
        cursor: pointer;
        opacity: 0.5;
        transition: all 0.3s;
        user-select: none;
      }
      .dark .lang-label {
        color: #94a3b8;
      }
      .lang-label.active {
        opacity: 1;
        color: #2563eb;
      }
      .dark .lang-label.active {
        color: #60a5fa;
      }

      .toggle-switch {
        position: relative;
        width: 36px;
        height: 20px;
        display: inline-block;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: 0.4s;
        border-radius: 20px;
      }
      .dark .toggle-slider {
        background-color: #475569;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      .toggle-switch input:checked + .toggle-slider {
        background-color: #2563eb;
      }
      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(16px);
      }

      /* Simple Background Mode */
      body.simple-bg {
        background: #f0f9ff !important;
        animation: none !important;
      }
      .dark body.simple-bg {
        background: #111827 !important;
      }
      body.simple-bg .weather-bg {
        display: none !important;
      }
    </style>
  </head>
  <body
    class="text-gray-800 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col"
  >
    <div class="weather-bg">
      <div class="sun"></div>
      <div class="cloud cloud1"></div>
      <div class="cloud cloud2"></div>
      <div class="cloud cloud3"></div>
      <div class="moon"></div>
      <div class="star star1"></div>
      <div class="star star2"></div>
      <div class="star star3"></div>
      <div class="star star4"></div>
      <div class="star star5"></div>
      <div class="star star6"></div>
      <div class="star star7"></div>
    </div>

    <svg height="0" width="0" style="position: absolute">
      <defs>
        <linearGradient
          id="departure-gradient"
          x1="0%"
          y1="0%"
          x2="0%"
          y2="100%"
        >
          <stop
            offset="0%"
            style="stop-color: rgba(0, 100, 0, 1); stop-opacity: 1"
          />
          <stop
            offset="100%"
            style="stop-color: rgba(50, 205, 50, 1); stop-opacity: 1"
          />
        </linearGradient>
        <linearGradient id="gradient-dark" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color: #60a5fa; stop-opacity: 1" />
          <stop offset="100%" style="stop-color: #2dd4bf; stop-opacity: 1" />
        </linearGradient>
      </defs>
    </svg>

    <nav id="navbar" class="navbar">
      <div class="max-w-7xl mx-auto px-4 py-2 flex flex-col gap-2">
        <!-- Top Row: Branding & Controls -->
        <div class="flex flex-wrap items-center justify-between w-full gap-4">
          <div class="flex items-center gap-3 nav-logo shrink-0">
            <img
              src="assets/logo.png"
              alt="IMD Logo"
              class="h-8 w-8 object-contain dark:invert"
            />
            <div>
              <h1 class="text-xl font-bold leading-tight gradient-text lang-hi">
                बिहार मानसून डैशबोर्ड
              </h1>
              <h1 class="text-xl font-bold leading-tight gradient-text lang-en">
                Bihar Monsoon Dashboard
              </h1>
              <div class="text-xs text-gray-500 dark:text-gray-400 lang-hi">
                IMD MC Patna — व्यापक विश्लेषण
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 lang-en">
                IMD MC Patna — Comprehensive Analysis
              </div>
            </div>
          </div>

          <div class="flex items-center gap-4 shrink-0">
            <!-- Language Switcher -->
            <div class="lang-switch-wrapper">
              <span
                class="lang-label active"
                id="lblHi"
                onclick="
                  document.getElementById('langToggle').checked = false;
                  toggleLanguage();
                "
                >HI</span
              >
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="langToggle"
                  onchange="toggleLanguage()"
                />
                <span class="toggle-slider"></span>
              </label>
              <span
                class="lang-label"
                id="lblEn"
                onclick="
                  document.getElementById('langToggle').checked = true;
                  toggleLanguage();
                "
                >EN</span
              >
            </div>

            <button
              id="bgToggleBtn"
              onclick="toggleBackground()"
              class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition"
              title="Toggle Background / बैकग्राउंड बदलें"
            >
              <i class="fa-solid fa-image text-blue-500 dark:text-blue-300"></i>
            </button>

            <button
              onclick="toggleDarkMode()"
              class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition"
            >
              <i class="fa-solid fa-moon dark:hidden text-gray-600"></i>
              <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
            </button>
          </div>
        </div>

        <!-- Bottom Row: Navigation Links -->
        <div class="flex justify-center w-full overflow-x-auto pb-1">
          <div class="flex nav-links-container text-sm font-semibold gap-4">
            <a
              href="index.html"
              class="nav-box active-nav lang-hi"
              onclick="setActive(this)"
              >होम</a
            >
            <a
              href="index.html"
              class="nav-box active-nav lang-en"
              onclick="setActive(this)"
              >Home</a
            >

            <a
              href="district.html"
              class="nav-box lang-hi"
              onclick="setActive(this)"
              >जिलावार</a
            >
            <a
              href="district.html"
              class="nav-box lang-en"
              onclick="setActive(this)"
              >District-wise</a
            >

            <a
              href="intensity.html"
              class="nav-box lang-hi"
              onclick="setActive(this)"
              >तीव्रता</a
            >
            <a
              href="intensity.html"
              class="nav-box lang-en"
              onclick="setActive(this)"
              >Intensity</a
            >

            <a
              href="maps.html"
              class="nav-box lang-hi"
              onclick="setActive(this)"
              >मानचित्र</a
            >
            <a
              href="maps.html"
              class="nav-box lang-en"
              onclick="setActive(this)"
              >Maps</a
            >

            <a
              href="history.html"
              class="nav-box lang-hi"
              onclick="setActive(this)"
              >ऐतिहासिक</a
            >
            <a
              href="history.html"
              class="nav-box lang-en"
              onclick="setActive(this)"
              >Historical</a
            >

            <a
              href="comparison.html"
              class="nav-box lang-hi"
              onclick="setActive(this)"
              >तुलना</a
            >
            <a
              href="comparison.html"
              class="nav-box lang-en"
              onclick="setActive(this)"
              >Comparison</a
            >
          </div>
        </div>
      </div>
    </nav>

    <main
      class="max-w-7xl mx-auto p-4 md:p-6 space-y-8 flex-grow flex flex-col w-full"
    >
      <header id="overview" class="text-center py-6 space-y-4">
        <h2 class="text-3xl md:text-4xl font-bold">
          <span class="gradient-text lang-hi"
            >बिहार मानसून सीजन वर्षा विश्लेषण
            <span class="yearDisplay">2025</span></span
          >
          <span class="gradient-text lang-en"
            >Bihar Monsoon Season Rainfall Analysis
            <span class="yearDisplay">2025</span></span
          >
        </h2>

        <div
          class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm inline-flex flex-wrap justify-center gap-6 mx-auto border border-gray-200 dark:border-gray-700"
        >
          <div class="flex flex-col items-center">
            <label
              for="yearSelect"
              class="text-3xl font-bold gradient-text mb-1 lang-hi"
              >वर्ष:</label
            >
            <label
              for="yearSelect"
              class="text-3xl font-bold gradient-text mb-1 lang-en"
              >Year:</label
            >
            <select
              id="yearSelect"
              onchange="updateDashboard()"
              class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-1.5 focus:ring-2 focus:ring-blue-500 font-bold w-32"
            ></select>
          </div>

          <div class="flex flex-col items-center">
            <label
              for="periodSelect"
              class="text-3xl font-bold gradient-text mb-1 lang-hi"
              >अवधि:</label
            >
            <label
              for="periodSelect"
              class="text-3xl font-bold gradient-text mb-1 lang-en"
              >Period:</label
            >
            <select
              id="periodSelect"
              onchange="updateDashboard()"
              class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-1.5 focus:ring-2 focus:ring-blue-500 font-bold w-64"
            >
              <option value="overall_monsoon" selected class="lang-hi">
                मानसून (जून-सितंबर)
              </option>
              <option value="overall_monsoon" selected class="lang-en">
                Monsoon (June-September)
              </option>
              <option value="june" class="lang-hi">जून</option>
              <option value="june" class="lang-en">June</option>
              <option value="july" class="lang-hi">जुलाई</option>
              <option value="july" class="lang-en">July</option>
              <option value="august" class="lang-hi">अगस्त</option>
              <option value="august" class="lang-en">August</option>
              <option value="september" class="lang-hi">सितंबर</option>
              <option value="september" class="lang-en">September</option>
            </select>
          </div>
        </div>

        <div
          class="flex justify-center items-center gap-4 text-lg font-bold mt-2"
        >
          <span class="gradient-text lang-hi"
            ><i class="fa-solid fa-map-location-dot"></i> कुल जिले: 38</span
          >
          <span class="gradient-text lang-en"
            ><i class="fa-solid fa-map-location-dot"></i> Total Districts:
            38</span
          >
        </div>

        <div
          class="bg-white dark:bg-carddark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-8 mt-4"
        >
          <div
            class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4 border-b border-gray-100 dark:border-gray-700 pb-4"
          >
            <h2
              class="text-2xl font-bold gradient-text flex items-center gap-2"
            >
              <i class="fas fa-calendar-alt"></i>
              <span class="lang-hi"
                >बिहार मानसून आगमन एवं वापसी समयरेखा वर्ष :
                <span class="yearDisplay">2025</span></span
              >
              <span class="lang-en"
                >Bihar Monsoon Onset & Withdrawal Timeline Year :
                <span class="yearDisplay">2025</span></span
              >
            </h2>
          </div>
          <div
            id="monsoonDetails"
            class="grid grid-cols-1 md:grid-cols-3 gap-6"
          ></div>
        </div>
      </header>

      <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
          <div class="text-blue-600 dark:text-blue-400 text-3xl mb-2">
            <i class="fa-solid fa-droplet"></i>
          </div>
          <div class="text-3xl font-bold gradient-text" id="statAvgRain">
            <span class="lang-en">--</span>
            <span class="lang-hi">--</span>
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-en">
            Average Rainfall of Bihar (mm)
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-hi">
            बिहार की औसत वर्षा (मिमी)
          </div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
          <div id="statIconDev" class="text-3xl mb-2">
            <i class="fa-solid fa-chart-line"></i>
          </div>
          <div class="text-3xl font-bold" id="statAvgDev">--</div>
          <div class="text-sm text-gray-500 mt-1 lang-en">
            Rainfall categories
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-en" id="statDevLabel">
            Departure
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-hi">वर्षा श्रेणियाँ</div>
          <div class="text-sm text-gray-500 mt-1 lang-hi" id="statDevLabel">
            विचलन
          </div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
          <div class="text-orange-500 text-3xl mb-2">
            <i class="fa-solid fa-triangle-exclamation"></i>
          </div>
          <div class="text-3xl font-bold gradient-text" id="statDeficitCount">
            <span class="lang-en">--</span>
            <span class="lang-hi">--</span>
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-en">
            No. of Districts:- Below Normal
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-hi">
            जिलों की संख्या:- सामान्य से कम
          </div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
          <div class="text-teal-600 dark:text-teal-400 text-3xl mb-2">
            <i class="fa-solid fa-trophy"></i>
          </div>
          <div
            class="text-xl font-bold truncate gradient-text"
            id="statMaxDist"
          >
            <span class="lang-en">--</span>
            <span class="lang-hi">--</span>
          </div>
          <div
            class="text-sm font-bold text-gray-600 dark:text-gray-300"
            id="statMaxVal"
          >
            <span class="lang-en">--</span>
            <span class="lang-hi">--</span>
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-en">
            Highest Rainfall Receive District
          </div>
          <div class="text-sm text-gray-500 mt-1 lang-hi">
            सर्वाधिक वर्षा प्राप्त करने वाला जिला
          </div>
        </div>
      </section>

      <section id="analysis" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div
          class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm lg:col-span-3"
        >
          <h3 class="text-lg font-bold flex items-center gap-2 mb-4">
            <i class="fa-solid fa-book-open text-orange-600"></i>
            <div class="gradient-text lang-en">
              Rainfall Classification (Legends)-
            </div>
            <div class="gradient-text lang-en">Category (%)-</div>
            <div class="gradient-text lang-en">No Of Districts</div>
            <div class="gradient-text lang-hi">वर्षा वर्गीकरण (Legends)-</div>
            <div class="gradient-text lang-hi">श्रेणियाँ (%)-</div>
            <div class="gradient-text lang-hi">जिलों की संख्या</div>
          </h3>
          <div id="legendTableContainer"></div>
        </div>
        <div
          class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm lg:col-span-3"
        >
          <h3 class="text-lg font-bold flex items-center gap-2 mb-2">
            <i class="fa-solid fa-chart-line text-purple-600"></i>
            <div class="gradient-text lang-hi">
              वास्तविक, सामान्य वर्षा और उसके विचलन का ग्राफ़
              <span class="dynamic-month-label lang-hi"
                >मानसून (जून-सितंबर)</span
              >
            </div>
            <span class="gradient-text lang-en"
              >Graph of Actual, Normal Rainfall and its Departure
              <span class="dynamic-month-label lang-en"
                >Monsoon (June-September)</span
              ></span
            >
          </h3>
          <div class="plotly-container">
            <div id="comparisonChart" class="w-full h-[500px]"></div>
          </div>
        </div>

        <div
          class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm lg:col-span-3"
        >
          <h3 class="text-lg font-bold flex items-center gap-2 mb-2">
            <i class="fa-solid fa-chart-column text-blue-600"></i>
            <span class="gradient-text lang-hi"
              >जिलावार वर्षा (विचलन)
              <span id="monthDisplay" class="dynamic-month-label lang-hi"
                >मानसून (जून-सितंबर)</span
              ></span
            >
            <span class="gradient-text lang-en"
              >District-wise Rainfall Anomalies (Departure)
              <span id="monthDisplay" class="dynamic-month-label lang-en"
                >Monsoon (June-September)</span
              ></span
            >
          </h3>
          <div class="plotly-container">
            <div id="deviationChart" class="w-full h-[500px]"></div>
          </div>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-chart-area text-blue-600"></i>
            <span class="gradient-text lang-hi"
              >मानसून मौसम के लिए वर्षा प्रवृत्ति की समय श्रृंखला वर्ष :
              <span class="yearDisplay">2025</span></span
            >
            <span class="gradient-text lang-en"
              >Time Series of Rainfall Trend for Monsoon Season Year :
              <span class="yearDisplay">2025</span></span
            >
          </h3>
          <div class="plotly-container">
            <div id="lineChart" class="w-full h-[400px]">
              <div class="text-center p-8 text-gray-500"></div>
            </div>
          </div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-orange-600"></i>
            <span class="gradient-text lang-hi"
              >जिलेवार वर्षा वर्गीकरण का % वितरण (Pie Chart)<span
                id="monthDisplay"
                class="dynamic-month-label lang-hi"
                >मानसून (जून-सितंबर)</span
              ></span
            >
            <span class="gradient-text lang-en"
              >% Distribution of District-wise Rainfall Classification (Pie
              Chart)<span id="monthDisplay" class="dynamic-month-label lang-en"
                >Monsoon (June-September)</span
              ></span
            >
          </h3>
          <div class="plotly-container">
            <div id="pieChart" class="w-full h-[400px]"></div>
          </div>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-1 gap-6">
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-list-ol text-purple-600"></i>
            <span class="gradient-text lang-hi"
              >सबसे ज़्यादा बारिश वाले (टॉप 5) और सबसे कम बारिश वाले (बॉटम 5)
              ज़िले</span
            >
            <span class="gradient-text lang-en"
              >Highest Rainfall receive (Top 5) and Lowest Rainfall receive
              (Bottom 5) Districts</span
            >
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="plotly-container">
              <div id="topDistChart" class="h-[400px]"></div>
            </div>
            <div class="plotly-container">
              <div id="botDistChart" class="h-[400px]"></div>
            </div>
          </div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-table-cells text-teal-600"></i>
            <span class="gradient-text lang-hi"
              >वर्षा वितरण मैट्रिक्स (Heatmap)<span
                id="monthDisplay"
                class="dynamic-month-label lang-hi"
                >मानसून (जून-सितंबर)</span
              ></span
            >
            <span class="gradient-text lang-en"
              >Rainfall Distribution Matrix (Heatmap)<span
                id="monthDisplay"
                class="dynamic-month-label lang-en"
                >Monsoon (June-September)</span
              ></span
            >
          </h3>
          <div class="plotly-container">
            <div id="heatmapChart" class="w-full h-[800px]">
              <div class="text-center p-8 text-gray-500"></div>
            </div>
          </div>
        </div>
      </section>

      <section
        id="maps-section"
        class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm text-center"
      >
        <div class="border-b border-gray-100 dark:border-gray-700 pb-4 mb-4">
          <h3
            class="text-2xl font-bold text-gray-800 dark:text-white flex items-center justify-center gap-2"
          >
            <i class="fa-solid fa-map text-teal-600"></i>
            <span class="gradient-text lang-hi">भौगोलिक मानचित्र विश्लेषण</span>
            <span class="gradient-text lang-en">Geographical Map Analysis</span>
          </h3>
          <p class="text-gray-500 dark:text-gray-400 text-sm mt-1 lang-hi">
            मासिक और समग्र वर्षा वितरण मानचित्र देखने के लिए अलग पृष्ठ पर जाएँ।
          </p>
          <p class="text-gray-500 dark:text-gray-400 text-sm mt-1 lang-en">
            Go to separate page to view monthly and overall rainfall
            distribution maps.
          </p>
        </div>
        <a
          href="maps.html"
          class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gradient-to-r from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
        >
          <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i>
          <span class="lang-hi">मानचित्र पृष्ठ खोलें</span>
          <span class="lang-en">Open Maps Page</span>
        </a>
      </section>

      <section
        id="data-table"
        class="card bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm"
      >
        <div
          class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <h3 class="text-xl font-bold text-gray-800 dark:text-white">
            <span class="gradient-text lang-hi">विस्तृत जिलावार डेटा:</span>
            <span class="gradient-text lang-en">Detailed District Data:</span>
            <span
              id="tableMonthLabel"
              class="dynamic-month-label text-blue-600 lang-hi"
              >मानसून (जून-सितंबर)
            </span>
            <span
              id="tableMonthLabel"
              class="dynamic-month-label text-blue-600 lang-en"
              >Monsoon (June-September)
            </span>
          </h3>
          <div class="flex items-center gap-4">
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
              </div>
              <input
                type="text"
                id="searchTable"
                onkeyup="filterAndSortTable()"
                placeholder="Search District / जिला खोजें"
                class="lang-en lang-hi pl-10 p-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-white text-sm w-64"
              />
            </div>
            <select
              id="tableSortBy"
              onchange="filterAndSortTable()"
              class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="district" class="lang-en">Sort by District</option>
              <option value="district" class="lang-hi">
                जिला के अनुसार क्रमबद्ध करें
              </option>
              <option value="actual" class="lang-en">
                Sort by Actual Rain
              </option>
              <option value="actual" class="lang-hi">
                वास्तविक वर्षा के अनुसार
              </option>
              <option value="deviation" class="lang-en">
                Sort by Departure
              </option>
              <option value="deviation" class="lang-hi">विचलन के अनुसार</option>
            </select>
          </div>
        </div>

        <div class="overflow-x-auto max-h-[500px]">
          <table
            class="w-full text-sm text-left text-gray-600 dark:text-gray-300"
          >
            <thead
              class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-900 dark:text-gray-300 sticky top-0 z-10"
            >
              <tr>
                <th
                  class="px-6 py-3 cursor-pointer sort-header hover:bg-gray-200 dark:hover:bg-gray-800 transition"
                  data-sort="district"
                  onclick="sortTable('district')"
                >
                  <span class="lang-en">District</span>
                  <span class="lang-hi">जिला</span>
                  <span class="sort-icon ml-1"
                    ><i class="fa-solid fa-sort"></i
                  ></span>
                </th>
                <th
                  class="px-6 py-3 text-right cursor-pointer sort-header hover:bg-gray-200 dark:hover:bg-gray-800 transition"
                  data-sort="actual"
                  onclick="sortTable('actual')"
                >
                  <span class="lang-en">Actual R/F (mm)</span>
                  <span class="lang-hi">वास्तविक वर्षा (मि.मि.)</span>
                  <span class="sort-icon ml-1"
                    ><i class="fa-solid fa-sort"></i
                  ></span>
                </th>
                <th
                  class="px-6 py-3 text-right cursor-pointer sort-header hover:bg-gray-200 dark:hover:bg-gray-800 transition"
                  data-sort="normal"
                  onclick="sortTable('normal')"
                >
                  <span class="lang-en">Normal R/F (mm)</span>
                  <span class="lang-hi">सामान्य वर्षा (मि.मि.)</span>
                  <span class="sort-icon ml-1"
                    ><i class="fa-solid fa-sort"></i
                  ></span>
                </th>
                <th
                  class="px-6 py-3 text-right cursor-pointer sort-header hover:bg-gray-200 dark:hover:bg-gray-800 transition"
                  data-sort="deviation"
                  onclick="sortTable('deviation')"
                >
                  <span class="lang-en">Departure (%)</span>
                  <span class="lang-hi">विचलन (%)</span>
                  <span class="sort-icon ml-1"
                    ><i class="fa-solid fa-sort"></i
                  ></span>
                </th>
                <th class="px-6 py-3 text-center">
                  <span class="lang-en">Status</span>
                  <span class="lang-hi">स्थिति</span>
                </th>
              </tr>
            </thead>
            <tbody
              id="dataTableBody"
              class="divide-y divide-gray-100 dark:divide-gray-700"
            >
              <tr>
                <td
                  colspan="5"
                  class="px-6 py-4 text-center text-gray-500 lang-en"
                >
                  Loading data...
                </td>
                <td
                  colspan="5"
                  class="px-6 py-4 text-center text-gray-500 lang-hi"
                >
                  डेटा लोड हो रहा है...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <footer
        class="bg-slate-800 text-white p-8 rounded-xl mt-auto text-center space-y-4 !mt-auto"
      >
        <h4 class="text-xl font-bold gradient-text lang-hi">
          डेटा स्रोत और क्रेडिट
        </h4>
        <h4 class="text-xl font-bold gradient-text lang-en">
          Data Source and Credits
        </h4>
        <p class="text-gray-300 lang-hi">
          India Meteorological Department: Meteorological Centre Patna
        </p>
        <p class="text-gray-300 lang-en">
          India Meteorological Department: Meteorological Centre Patna
        </p>
        <div class="pt-4 border-t border-slate-700">
          <p class="text-sm text-gray-400 lang-hi">विश्लेषण तैयार किया गया:</p>
          <p class="text-sm text-gray-400 lang-en">Analysis Prepared by:</p>
          <p class="text-lg font-semibold">© Lal Kamal</p>
        </div>
      </footer>
    </main>

    <script>
      // --- Global Configuration for Plotly Charts ---
      const PLOTLY_CONFIG = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: [
          "lasso2d",
          "select2d",
          "sendDataToCloud",
          "hoverClosestCartesian",
          "hoverCompareCartesian",
          "toggleSpikelines",
        ],
        displaylogo: false,
      };

      // --- UI Logic: Active Tab Switching ---
      function setActive(element) {
        document
          .querySelectorAll(".nav-box")
          .forEach((el) => el.classList.remove("active-nav"));
        element.classList.add("active-nav");
      }

      // --- Smooth Scroll Function for Dashboard ---
      function smoothScrollToAnalysis(event) {
        event.preventDefault();
        setActive(event.currentTarget);
        const targetElement = document.getElementById("analysis");
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }

      // --- Language Switching ---
      let currentLanguage = "hi"; // Default to Hindi

      function toggleLanguage() {
        const toggle = document.getElementById("langToggle");
        const isEnglish = toggle.checked;
        currentLanguage = isEnglish ? "en" : "hi";

        if (isEnglish) {
          document.body.classList.add("english");
          document.getElementById("lblEn").classList.add("active");
          document.getElementById("lblHi").classList.remove("active");
        } else {
          document.body.classList.remove("english");
          document.getElementById("lblHi").classList.add("active");
          document.getElementById("lblEn").classList.remove("active");
        }

        updateLanguageContent();
        if (window.globalData) {
          updateDashboardUI(window.globalData);
        }
        if (window.globalMonthlyData) {
          const periodKey = document.getElementById("periodSelect").value;
          renderMonthlyCharts(window.globalMonthlyData, periodKey);
        }
      }

      function updateLanguageContent() {
        const isEnglish = currentLanguage === "en";
        const year = document.getElementById("yearDisplay").textContent;
        const periodKey = document.getElementById("periodSelect").value;
        const monthLabel = getMonthLabel(periodKey, isEnglish);
        const fullLabel = `${monthLabel} - ${year}`;

        // Update dynamic labels
        document.querySelectorAll(".dynamic-month-label").forEach((el) => {
          el.textContent = fullLabel;
        });

        // Update static elements
        document.querySelector("main h2 .lang-hi").style.display = isEnglish
          ? "none"
          : "block";
        document.querySelector("main h2 .lang-en").style.display = isEnglish
          ? "block"
          : "none";

        // Update labels
        document.querySelector(
          'label[for="yearSelect"].lang-hi',
        ).style.display = isEnglish ? "none" : "block";
        document.querySelector(
          'label[for="yearSelect"].lang-en',
        ).style.display = isEnglish ? "block" : "none";
        document.querySelector(
          'label[for="periodSelect"].lang-hi',
        ).style.display = isEnglish ? "none" : "block";
        document.querySelector(
          'label[for="periodSelect"].lang-en',
        ).style.display = isEnglish ? "block" : "none";

        // Update footer
        document.querySelector("footer h4.lang-hi").style.display = isEnglish
          ? "none"
          : "block";
        document.querySelector("footer h4.lang-en").style.display = isEnglish
          ? "block"
          : "none";
        document.querySelector("footer p.lang-hi").style.display = isEnglish
          ? "none"
          : "block";
        document.querySelector("footer p.lang-en").style.display = isEnglish
          ? "block"
          : "none";
        document.querySelector("footer .lang-hi").style.display = isEnglish
          ? "none"
          : "block";
        document.querySelector("footer .lang-en").style.display = isEnglish
          ? "block"
          : "none";

        // Update max/min box
        document.querySelector("#maxRainDistrict").textContent =
          document.querySelector("#maxRainDistrict").textContent;
        document.querySelector("#minRainDistrict").textContent =
          document.querySelector("#minRainDistrict").textContent;

        // Update stats
        updateStatsLanguage();

        // Update table headers
        updateTableHeaders(isEnglish);
      }

      function getMonthLabel(periodKey, isEnglish) {
        const monthNames = {
          overall_monsoon: {
            en: "Monsoon (June-September)",
            hi: "मानसून (जून-सितंबर)",
          },
          june: { en: "June", hi: "जून" },
          july: { en: "July", hi: "जुलाई" },
          august: { en: "August", hi: "अगस्त" },
          september: { en: "September", hi: "सितंबर" },
        };
        return monthNames[periodKey][isEnglish ? "en" : "hi"];
      }

      function updateStatsLanguage() {
        const isEnglish = currentLanguage === "en";
        const avgRain = document.getElementById("statAvgRain");
        const avgRainText = avgRain.textContent
          .replace(" मिमी", "")
          .replace(" mm", "");
        avgRain.innerHTML = `<span class="lang-en">${avgRainText} mm</span><span class="lang-hi">${avgRainText} मिमी</span>`;

        document.getElementById("statDevLabel").textContent = isEnglish
          ? "Departure"
          : "विचलन";
        document.getElementById("statDeficitCount").innerHTML =
          `<span class="lang-en">${document.getElementById("statDeficitCount").textContent}</span><span class="lang-hi">${document.getElementById("statDeficitCount").textContent}</span>`;
        document.getElementById("statMaxDist").innerHTML =
          `<span class="lang-en">${document.getElementById("statMaxDist").textContent}</span><span class="lang-hi">${document.getElementById("statMaxDist").textContent}</span>`;
        document.getElementById("statMaxVal").innerHTML =
          `<span class="lang-en">${document.getElementById("statMaxVal").textContent.replace(" मिमी", " mm")}</span><span class="lang-hi">${document.getElementById("statMaxVal").textContent.replace(" mm", " मिमी")}</span>`;
      }

      function updateTableHeaders(isEnglish) {
        const headers = document.querySelectorAll("#data-table thead th");
        headers.forEach((header, index) => {
          const enSpan = header.querySelector(".lang-en");
          const hiSpan = header.querySelector(".lang-hi");
          if (enSpan && hiSpan) {
            enSpan.style.display = isEnglish ? "block" : "none";
            hiSpan.style.display = isEnglish ? "none" : "block";
          }
        });

        // Update search placeholder
        const searchInput = document.getElementById("searchTable");
        searchInput.placeholder = isEnglish ? "Search District" : "जिला खोजें";

        // Update sort dropdown
        const sortOptions = document.querySelectorAll("#tableSortBy option");
        sortOptions.forEach((option) => {
          if (option.classList.contains("lang-en"))
            option.style.display = isEnglish ? "block" : "none";
          if (option.classList.contains("lang-hi"))
            option.style.display = isEnglish ? "none" : "block";
        });
      }

      function toggleDarkMode() {
        document.documentElement.classList.toggle("dark");
        const periodKey = document.getElementById("periodSelect").value;
        if (window.globalData) {
          updateDashboardUI(window.globalData);
        } else {
          updateDashboard();
        }
        if (window.globalMonthlyData) {
          renderMonthlyCharts(window.globalMonthlyData, periodKey);
        }
        renderLegendTable();
      }

      // --- Background Toggle ---
      function toggleBackground() {
        document.body.classList.toggle("simple-bg");
        const isSimple = document.body.classList.contains("simple-bg");
        localStorage.setItem("simpleBackground", isSimple ? "true" : "false");
        updateBackgroundBtnIcon(isSimple);
      }

      function updateBackgroundBtnIcon(isSimple) {
        const btn = document.getElementById("bgToggleBtn");
        if (!btn) return;
        if (isSimple) {
          btn.innerHTML = '<i class="fa-solid fa-ban text-gray-400"></i>';
        } else {
          btn.innerHTML =
            '<i class="fa-solid fa-image text-blue-500 dark:text-blue-300"></i>';
        }
      }

      // --- Data Mapping ---
      const monthDisplayNames = {
        overall_monsoon: {
          en: "Monsoon (June-September)",
          hi: "मानसून (जून-सितंबर)",
        },
        september: { en: "September", hi: "सितंबर" },
        august: { en: "August", hi: "अगस्त" },
        july: { en: "July", hi: "जुलाई" },
        june: { en: "June", hi: "जून" },
      };

      // वैश्विक वैरिएबल
      window.globalData = [];
      window.globalMonthlyData = [];

      // --- Central Color Scheme using HEX values ---
      const RAINFALL_COLORS_HEX = {
        "LARGE EXCESS": "#1565c0", // dark blue (+60% and above)
        EXCESS: "#4fc3f7", // light blue (+20% to +59%)
        NORMAL: "#4caf50", // green (-19% to +19%)
        DEFICIENT: "#e53935", // red (-20% to -59%)
        "LARGE DEFICIENT": "#ffd700", // yellow (-60% to -99%)
        "NO RAIN": "#ffffff", // white (-100%)
      };

      const rainfallLegends = [
        // Updated colors and corresponding text colors for contrast
        {
          name: "LARGE EXCESS",
          range: "+60% and above",
          color: RAINFALL_COLORS_HEX["LARGE EXCESS"],
          count: 0,
          textColor: "white",
        },
        {
          name: "EXCESS",
          range: "+20% to +59%",
          color: RAINFALL_COLORS_HEX["EXCESS"],
          count: 0,
          textColor: "black",
        },
        {
          name: "NORMAL",
          range: "-19% to +19%",
          color: RAINFALL_COLORS_HEX["NORMAL"],
          count: 0,
          textColor: "white",
        },
        {
          name: "DEFICIENT",
          range: "-20% to -59%",
          color: RAINFALL_COLORS_HEX["DEFICIENT"],
          count: 0,
          textColor: "white",
        },
        {
          name: "LARGE DEFICIENT",
          range: "-60% to -99%",
          color: RAINFALL_COLORS_HEX["LARGE DEFICIENT"],
          count: 0,
          textColor: "black",
        },
        {
          name: "NO RAIN",
          range: "-100%",
          color: RAINFALL_COLORS_HEX["NO RAIN"],
          count: 0,
          textColor: "black",
        },
      ];

      /**
       * CSV फ़ाइल को फ़ETCH करता है और Papa Parse का उपयोग करके उसे JSON Array में पार्स करता है।
       */
      async function loadCSVData(year, periodKey) {
        const filePath = `data/${year}/${periodKey}.csv`;

        try {
          console.log(`Fetching data from: ${filePath}`);

          const response = await fetch(filePath);

          if (!response.ok) {
            throw new Error(`डेटा फ़ाइल नहीं मिली: ${filePath}`);
          }

          const csvText = await response.text();

          return new Promise((resolve, reject) => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              complete: function (results) {
                if (results.errors.length) {
                  console.error("Papa Parse त्रुटियाँ:", results.errors);
                  reject(new Error("CSV पार्सिंग विफल रही।"));
                  return;
                }
                resolve(results.data);
              },
              error: function (err) {
                reject(err);
              },
            });
          });
        } catch (error) {
          console.error(`CSV लोड करने में विफलता (${periodKey}):`, error);
          throw error;
        }
      }

      /**
       * कच्चे सिंगल-मंथ CSV डेटा को विज़ुअलाइज़ेशन के लिए आवश्यक फ़ॉर्मेट में प्रोसेस करता है।
       */
      function getProcessedData(rawData) {
        return rawData
          .map((d) => {
            const actualStr = d["Actual R/F (mm)"];
            const normalStr = d["Normal R/F (mm)"];
            const deviationStr = d["Departure"];

            const actual = parseFloat(actualStr);
            const normal = parseFloat(normalStr);
            const deviation = parseInt(deviationStr);

            return {
              district: d["DISTRICT NAME"]
                ? d["DISTRICT NAME"].trim()
                : "Unknown",
              actual: isNaN(actual) ? 0 : actual,
              normal: isNaN(normal) ? 0 : normal,
              deviation: isNaN(deviation) ? 0 : deviation,
              status: getRainfallStatus(deviation),
            };
          })
          .filter((d) => d.district !== "Unknown");
      }

      /**
       * विचलन के आधार पर श्रेणी निर्धारित करता है।
       */
      function getRainfallStatus(deviation) {
        if (deviation >= 60) return "LARGE EXCESS";
        if (deviation > 19) return "EXCESS";
        if (deviation >= -19) return "NORMAL";
        if (deviation >= -59) return "DEFICIENT";
        if (deviation === -100) return "NO RAIN";
        return "LARGE DEFICIENT";
      }

      /**
       * कच्चे मासिक संयुक्त CSV डेटा को प्रोसेस करता है
       */
      function getProcessedMonthlyData(rawData) {
        return rawData
          .map((d) => {
            const actual = parseFloat(d["Actual R/F (mm)"]) || 0;
            const normal = parseFloat(d["Normal R/F (mm)"]) || 0;
            const deviation = parseInt(d["Departure"]) || 0;

            return {
              district: d["DISTRICT NAME"]
                ? d["DISTRICT NAME"].trim()
                : "Unknown",
              month: d["MONTH"] ? d["MONTH"].trim() : "Unknown",
              actual: actual,
              normal: normal,
              deviation: deviation,
            };
          })
          .filter((d) => d.district !== "Unknown");
      }

      // --- Dashboard Control ---

      async function updateDashboard() {
        const year = document.getElementById("yearSelect").value;
        const periodKey = document.getElementById("periodSelect").value;
        const monthLabel = monthDisplayNames[periodKey][currentLanguage];
        const fullLabel = `${monthLabel} - ${year}`;

        // UI लेबल अपडेट करें
        const yearElements = document.querySelectorAll(".yearDisplay");
        yearElements.forEach((el) => {
          el.innerText = year;
        });
        document.getElementById("monthDisplay").innerText = fullLabel;
        document.getElementById("tableMonthLabel").innerText = fullLabel;
        document
          .querySelectorAll(".dynamic-month-label")
          .forEach((el) => (el.innerText = fullLabel));

        // 1. सिंगल CSV डेटा लोड करें
        try {
          const rawData = await loadCSVData(year, periodKey);
          window.globalData = rawData;
          updateDashboardUI(rawData);
        } catch (error) {
          console.error("सिंगल डैशबोर्ड अपडेट में त्रुटि:", error);
          const errorMsg =
            currentLanguage === "en"
              ? `Data could not be loaded. Please ensure the file data/${year}/${periodKey}.csv exists.`
              : `डेटा लोड नहीं हो सका। कृपया सुनिश्चित करें कि फ़ाइल data/${year}/${periodKey}.csv मौजूद है।`;

          document.getElementById("dataTableBody").innerHTML =
            `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500 font-semibold">${errorMsg}</td></tr>`;

          // Clear all chart areas
          renderStats([]);
          renderLegendTable(calculateLegendCounts([]));
          Plotly.purge("deviationChart");
          Plotly.purge("comparisonChart");
          Plotly.purge("pieChart");
          Plotly.purge("topDistChart");
          Plotly.purge("botDistChart");
          Plotly.purge("lineChart");
          Plotly.purge("heatmapChart");
        }

        // 2. मासिक संयुक्त डेटा लोड करें
        loadAndRenderMonthlyCharts(year, periodKey);

        // --- यहाँ नया बदलाव जोड़ा गया है ---
        // यह मानसून आगमन और वापसी वाले ब्लॉक को अपडेट करेगा
        if (typeof updateMonsoonUI === "function") {
          updateMonsoonUI(year);
        }
      }

      async function loadAndRenderMonthlyCharts(year, selectedPeriodKey) {
        try {
          const rawMonthlyData = await loadCSVData(year, "monthly_combined");
          window.globalMonthlyData = getProcessedMonthlyData(rawMonthlyData);
          renderMonthlyCharts(window.globalMonthlyData, selectedPeriodKey);
        } catch (error) {
          console.error("Monthly combined data load failed:", error);
          // Clear monthly charts if combined data is missing
          Plotly.purge("lineChart");
          Plotly.purge("heatmapChart");
        }
      }

      function renderMonthlyCharts(data, selectedPeriodKey) {
        if (data && data.length > 0) {
          renderLineChart(data);
          renderHeatmap(data, selectedPeriodKey);
        }
      }

      function updateDashboardUI(rawData) {
        const processedData = getProcessedData(rawData);
        const counts = calculateLegendCounts(processedData);

        // Update max/min rainfall display

        renderLegendTable(counts);
        renderStats(processedData);
        renderMainCharts(processedData);
        renderTable(processedData);
      }

      // --- Calculate counts for Legend Table ---
      function calculateLegendCounts(data) {
        const counts = {
          "LARGE EXCESS": 0,
          EXCESS: 0,
          NORMAL: 0,
          DEFICIENT: 0,
          "LARGE DEFICIENT": 0,
          "NO RAIN": 0,
        };
        data.forEach((d) => {
          const status = getRainfallStatus(d.deviation);
          if (counts.hasOwnProperty(status)) {
            counts[status]++;
          }
        });
        return counts;
      }

      // --- Render Legend Table ---
      function renderLegendTable(counts) {
        const container = document.getElementById("legendTableContainer");

        let htmlContent =
          '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-2 text-center">';

        rainfallLegends.forEach((legend) => {
          const count =
            counts && counts[legend.name] !== undefined
              ? counts[legend.name]
              : "--";
          const textColor = legend.textColor;

          htmlContent += `
                <div class="rounded-lg shadow-md overflow-hidden transition transform hover:scale-[1.02] cursor-default border border-gray-200 dark:border-gray-700">
                    <div style="background-color: ${legend.color}; color: ${textColor};" class="font-bold text-xs py-1 px-1">
                        ${legend.name}
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs py-1 font-mono">
                        ${legend.range}
                    </div>
                    <div class="bg-white dark:bg-gray-800 text-sm py-1.5 px-1 font-bold">
                        <span class="gradient-text">${count}</span>
                    </div>
                </div>
            `;
        });

        htmlContent += "</div>";
        container.innerHTML = htmlContent;
      }

      // --- Render Stats ---
      function renderStats(data) {
        if (data.length === 0) {
          document.getElementById("statAvgRain").innerText = "--";
          document.getElementById("statAvgDev").innerText = "--";
          document.getElementById("statDeficitCount").innerText = "--";
          document.getElementById("statMaxDist").innerText = "--";
          document.getElementById("statMaxVal").innerText = "--";
          return;
        }

        const totalActual = data.reduce((sum, d) => sum + d.actual, 0);
        const totalNormal = data.reduce((sum, d) => sum + d.normal, 0);
        const avgActual = (totalActual / data.length).toFixed(1);

        let avgDev = 0;
        if (totalNormal > 0) {
          avgDev = Math.round(
            ((totalActual - totalNormal) / totalNormal) * 100,
          );
        }

        const deficitCount = data.filter((d) => d.deviation < -19).length;
        const maxDist = data.reduce((prev, current) =>
          prev.actual > current.actual ? prev : current,
        );

        document.getElementById("statAvgRain").innerText =
          `${avgActual} ${currentLanguage === "en" ? "mm" : "मिमी"}`;
        const devElem = document.getElementById("statAvgDev");
        devElem.innerText = `${avgDev}%`;

        let colorClass = "text-gray-600";
        let iconClass = "text-gray-500";
        let labelText = currentLanguage === "en" ? "Departure" : "विचलन";
        if (avgDev < -19) {
          colorClass = "text-red-600";
          iconClass = "text-red-500";
          labelText =
            currentLanguage === "en" ? "Below Normal" : "सामान्य से कम";
        } else if (avgDev > 19) {
          colorClass = "text-green-600";
          iconClass = "text-green-500";
          labelText = currentLanguage === "en" ? "Normal/Above" : "सामान्य/ऊपर";
        } else {
          colorClass = "text-blue-600";
          iconClass = "text-blue-500";
          labelText =
            currentLanguage === "en" ? "In Normal Range" : "सामान्य सीमा में";
        }

        devElem.className = `text-3xl font-bold ${colorClass}`;
        document.getElementById("statIconDev").className =
          `text-3xl mb-2 ${iconClass}`;
        document.getElementById("statDevLabel").innerText = labelText;

        document.getElementById("statDeficitCount").innerText = deficitCount;
        document.getElementById("statMaxDist").innerText = maxDist.district;
        document.getElementById("statMaxVal").innerText =
          `${maxDist.actual} ${currentLanguage === "en" ? "mm" : "मिमी"}`;
      }

      function renderMainCharts(data) {
        if (data.length === 0) {
          Plotly.purge("deviationChart");
          Plotly.purge("comparisonChart");
          Plotly.purge("pieChart");
          Plotly.purge("topDistChart");
          Plotly.purge("botDistChart");
          return;
        }

        const isDark = document.documentElement.classList.contains("dark");
        const fontColor = isDark ? "#cbd5e1" : "#334155";

        const layoutConfig = {
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          font: { family: "Poppins", color: fontColor },
          xaxis: { showgrid: false },
          yaxis: { showgrid: true, gridcolor: isDark ? "#374151" : "#e2e8f0" },
        };

        const gradientId = isDark ? "gradient-dark" : "gradient";

        // --- COMPARISON CHART ---
        const traceActual = {
          x: data.map((d) => d.district),
          y: data.map((d) => d.actual),
          type: "scatter",
          mode: "lines+markers",
          name:
            currentLanguage === "en"
              ? "Actual R/F (mm)"
              : "वास्तविक वर्षा (मिमी)",
          line: { color: "#42A5F5", width: 3, shape: "spline" },
          marker: { size: 6, color: "#42A5F5", symbol: "circle" },
        };

        const traceNormal = {
          x: data.map((d) => d.district),
          y: data.map((d) => d.normal),
          type: "scatter",
          mode: "lines+markers",
          name:
            currentLanguage === "en"
              ? "Normal R/F (mm)"
              : "सामान्य वर्षा (मिमी)",
          line: { color: "#EF5350", width: 3, shape: "spline", dash: "dash" },
          marker: { size: 6, color: "#EF5350", symbol: "diamond" },
        };

        const traceDeparture = {
          x: data.map((d) => d.district),
          y: data.map((d) => d.deviation),
          type: "scatter",
          mode: "lines+markers",
          name: currentLanguage === "en" ? "Departure (%)" : "विचलन (%)",
          line: { color: "#2dd4bf", width: 2.5, shape: "spline" },
          marker: { size: 7, color: "#2dd4bf", symbol: "diamond-open" },
          yaxis: "y2",
          hovertemplate:
            currentLanguage === "en"
              ? "<b>%{x}</b><br>Departure: %{y}%<extra></extra>"
              : "<b>%{x}</b><br>विचलन: %{y}%<extra></extra>",
        };

        // Title removed from Comparison Chart
        Plotly.newPlot(
          "comparisonChart",
          [traceActual, traceNormal, traceDeparture],
          {
            ...layoutConfig,
            margin: { t: 30, b: 150, l: 80, r: 80 },
            yaxis: {
              title:
                currentLanguage === "en" ? "Rainfall (mm)" : "वर्षा (मिमी)",
              titlefont: { color: "transparent" },
              tickfont: { color: fontColor },
            },
            yaxis2: {
              title: currentLanguage === "en" ? "Departure (%)" : "विचलन (%)",
              overlaying: "y",
              side: "right",
              showgrid: false,
              zeroline: true,
              titlefont: { color: "transparent" },
              tickfont: { color: fontColor },
            },
            xaxis: {
              tickangle: 90,
              automargin: true,
              tickfont: { size: 10 },
            },
            legend: { orientation: "h", y: 1.1 },
            dragmode: "pan",
            hovermode: "x unified",
          },
          PLOTLY_CONFIG,
        );

        // --- Deviation Chart ---
        const deviationColors = data.map((d) => {
          if (d.deviation >= 60) return RAINFALL_COLORS_HEX["LARGE EXCESS"];
          if (d.deviation > 19) return RAINFALL_COLORS_HEX["EXCESS"];
          if (d.deviation >= -19) return RAINFALL_COLORS_HEX["NORMAL"];
          if (d.deviation >= -59) return RAINFALL_COLORS_HEX["DEFICIENT"];
          if (d.deviation == -100) return RAINFALL_COLORS_HEX["NO RAIN"];
          return RAINFALL_COLORS_HEX["LARGE DEFICIENT"];
        });

        // Title removed from Deviation Chart
        Plotly.newPlot(
          "deviationChart",
          [
            {
              x: data.map((d) => d.district),
              y: data.map((d) => d.deviation),
              type: "bar",
              marker: { color: deviationColors },
              hovertemplate:
                currentLanguage === "en"
                  ? "<b>%{x}</b><br>Departure: %{y}%<extra></extra>"
                  : "<b>%{x}</b><br>विचलन: %{y}%<extra></extra>",
            },
          ],
          {
            ...layoutConfig,
            margin: { t: 30, b: 150, l: 80, r: 10 },
            yaxis: {
              title: currentLanguage === "en" ? "Departure (%)" : "विचलन (%)",
              titlefont: { color: "transparent" },
            },
            xaxis: {
              tickangle: 90,
              automargin: true,
              tickfont: { size: 10 },
            },
            dragmode: "pan",
          },
          PLOTLY_CONFIG,
        );

        // --- Top/Bottom Charts ---
        const sorted = [...data].sort((a, b) => b.actual - a.actual);
        const top5 = sorted.slice(0, 5).reverse();
        const bot5 = sorted.slice(-5);

        const barLayout = {
          ...layoutConfig,
          margin: { l: 100, t: 10, b: 30, r: 10 },
          xaxis: {
            title:
              currentLanguage === "en"
                ? "Actual R/F (mm)"
                : "वास्तविक वर्षा (मिमी)",
          },
          height: 400,
        };

        Plotly.newPlot(
          "topDistChart",
          [
            {
              y: top5.map((d) => d.district),
              x: top5.map((d) => d.actual),
              type: "bar",
              orientation: "h",
              marker: { color: "#059669" },
              hovertemplate:
                currentLanguage === "en"
                  ? "<b>%{y}</b>: %{x} mm<extra>Top 5</extra>"
                  : "<b>%{y}</b>: %{x} मि.मि.<extra>टॉप 5</extra>",
            },
          ],
          barLayout,
          PLOTLY_CONFIG,
        );

        Plotly.newPlot(
          "botDistChart",
          [
            {
              y: bot5.map((d) => d.district),
              x: bot5.map((d) => d.actual),
              type: "bar",
              orientation: "h",
              marker: { color: "#ea580c" },
              hovertemplate:
                currentLanguage === "en"
                  ? "<b>%{y}</b>: %{x} mm<extra>Bottom 5</extra>"
                  : "<b>%{y}</b>: %{x} मि.मि.<extra>बॉटम 5</extra>",
            },
          ],
          barLayout,
          PLOTLY_CONFIG,
        );

        // --- Pie Chart ---
        const counts = calculateLegendCounts(data);

        const pieData = [
          {
            label:
              currentLanguage === "en"
                ? "LARGE EXCESS (+60% or more)"
                : "अत्यधिक अधिक (+60% या अधिक)",
            value: counts["LARGE EXCESS"],
            color: RAINFALL_COLORS_HEX["LARGE EXCESS"],
          },
          {
            label:
              currentLanguage === "en"
                ? "EXCESS (+20% to +59%)"
                : "अधिक (+20% से +59%)",
            value: counts["EXCESS"],
            color: RAINFALL_COLORS_HEX["EXCESS"],
          },
          {
            label:
              currentLanguage === "en"
                ? "NORMAL (-19% to +19%)"
                : "सामान्य (-19% से +19%)",
            value: counts["NORMAL"],
            color: RAINFALL_COLORS_HEX["NORMAL"],
          },
          {
            label:
              currentLanguage === "en"
                ? "DEFICIENT (-20% to -59%)"
                : "कम (-20% से -59%)",
            value: counts["DEFICIENT"],
            color: RAINFALL_COLORS_HEX["DEFICIENT"],
          },
          {
            label:
              currentLanguage === "en"
                ? "LARGE DEFICIENT (-60% to -99%)"
                : "अत्यधिक कम (-60% से -99%)",
            value: counts["LARGE DEFICIENT"],
            color: RAINFALL_COLORS_HEX["LARGE DEFICIENT"],
          },
          {
            label:
              currentLanguage === "en"
                ? "NO RAIN (-100%)"
                : "बिना वर्षा (-100%)",
            value: counts["NO RAIN"],
            color: RAINFALL_COLORS_HEX["NO RAIN"],
          },
        ]
          .filter((d) => d.value > 0)
          .sort((a, b) => b.value - a.value);

        const pieValues = pieData.map((d) => d.value);
        const pieLabels = pieData.map((d) => `${d.label} (${d.value})`);
        const pieColors = pieData.map((d) => d.color);

        Plotly.newPlot(
          "pieChart",
          [
            {
              values: pieValues,
              labels: pieLabels,
              type: "pie",
              hole: 0.5,
              marker: { colors: pieColors },
              textinfo: "percent",
              automargin: true,
            },
          ],
          {
            ...layoutConfig,
            showlegend: true,
            legend: {
              orientation: "v",
              y: 0.5,
              x: 1.05,
              bgcolor: "rgba(0,0,0,0)",
              bordercolor: "rgba(0,0,0,0)",
            },
            margin: { l: 20, r: 150, t: 30, b: 30 },
          },
          PLOTLY_CONFIG,
        );
      }

      // --- Line Chart ---
      function renderLineChart(data) {
        const monthlyAverages = {};
        const monthOrder = ["June", "July", "August", "September"];

        data.forEach((d) => {
          if (!monthlyAverages[d.month]) {
            monthlyAverages[d.month] = {
              totalActual: 0,
              totalNormal: 0,
              count: 0,
            };
          }
          monthlyAverages[d.month].totalActual += d.actual;
          monthlyAverages[d.month].totalNormal += d.normal;
          monthlyAverages[d.month].count++;
        });

        const plotMonths = monthOrder.filter((m) => monthlyAverages[m]);
        const avgActuals = plotMonths.map((m) =>
          (monthlyAverages[m].totalActual / monthlyAverages[m].count).toFixed(
            1,
          ),
        );
        const avgNormals = plotMonths.map((m) =>
          (monthlyAverages[m].totalNormal / monthlyAverages[m].count).toFixed(
            1,
          ),
        );

        const isDark = document.documentElement.classList.contains("dark");
        const fontColor = isDark ? "#cbd5e1" : "#334155";
        const gradientId = isDark ? "gradient-dark" : "gradient";

        // Title removed from Line Chart
        Plotly.newPlot(
          "lineChart",
          [
            {
              x: plotMonths,
              y: avgActuals,
              mode: "lines+markers",
              name:
                currentLanguage === "en" ? "Actual Average" : "वास्तविक औसत",
              line: { color: "#2563eb", width: 3 },
              marker: { size: 8 },
            },
            {
              x: plotMonths,
              y: avgNormals,
              mode: "lines+markers",
              name: currentLanguage === "en" ? "Normal Average" : "सामान्य औसत",
              line: { color: "#0d9488", dash: "dash", width: 2 },
              marker: { size: 6 },
            },
          ],
          {
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0)",
            font: { family: "Poppins", color: fontColor },
            margin: { t: 30, b: 60, l: 80, r: 10 },
            xaxis: {
              title: currentLanguage === "en" ? "Month" : "महीना",
              showgrid: false,
            },
            yaxis: {
              title:
                currentLanguage === "en" ? "Rainfall (mm)" : "वर्षा (मिमी)",
              showgrid: true,
              gridcolor: isDark ? "#374151" : "#e2e8f0",
              titlefont: { color: "transparent" },
            },
            legend: { orientation: "h", y: -0.2 },
            annotations: [
              {
                xref: "paper",
                yref: "paper",
                text:
                  currentLanguage === "en"
                    ? "<b>Rainfall (mm)</b>"
                    : "<b>वर्षा (मिमी)</b>",
                x: -0.05,
                y: 0.5,
                textangle: -90,
                font: { color: `url(#${gradientId})`, size: 16 },
              },
            ],
          },
          PLOTLY_CONFIG,
        );
      }

      // --- Heatmap Chart ---
      function renderHeatmap(data, selectedPeriodKey) {
        const isDark = document.documentElement.classList.contains("dark");
        const fontColor = isDark ? "#cbd5e1" : "#334155";

        const allMonthsOrder = ["June", "July", "August", "September"];
        let monthsToShow = allMonthsOrder;

        if (
          allMonthsOrder
            .map((m) => m.toLowerCase())
            .includes(selectedPeriodKey.toLowerCase())
        ) {
          const capitalizedMonth =
            selectedPeriodKey.charAt(0).toUpperCase() +
            selectedPeriodKey.slice(1).toLowerCase();
          monthsToShow = [capitalizedMonth];
        }

        const districts = [...new Set(data.map((d) => d.district))].sort();

        const zData = districts.map((district) => {
          return monthsToShow.map((month) => {
            const record = data.find(
              (d) => d.district === district && d.month === month,
            );
            return record ? record.deviation : null;
          });
        });

        const customColorScale = [
          [0.0, RAINFALL_COLORS_HEX["NO RAIN"]], // -100%
          [0.2, RAINFALL_COLORS_HEX["LARGE DEFICIENT"]], // -60%
          [0.4, RAINFALL_COLORS_HEX["DEFICIENT"]], // -20%
          [0.5, RAINFALL_COLORS_HEX["NORMAL"]], // 0% (Center)
          [0.6, RAINFALL_COLORS_HEX["NORMAL"]], // +20%
          [0.8, RAINFALL_COLORS_HEX["EXCESS"]], // +60%
          [1.0, RAINFALL_COLORS_HEX["LARGE EXCESS"]], // +100%
        ];

        Plotly.newPlot(
          "heatmapChart",
          [
            {
              z: zData,
              x: monthsToShow,
              y: districts,
              type: "heatmap",
              colorscale: customColorScale,
              zmin: -100,
              zmax: 100,
              showscale: true,
              colorbar: {
                title: currentLanguage === "en" ? "Departure (%)" : "विचलन (%)",
                titleside: "top",
                thickness: 15,
                len: 0.9,
              },
              hoverongaps: false,
              hovertemplate:
                currentLanguage === "en"
                  ? "<b>%{y}</b><br>%{x}: %{z}%<extra></extra>"
                  : "<b>%{y}</b><br>%{x}: %{z}%<extra></extra>",
            },
          ],
          {
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0)",
            font: { family: "Poppins", color: fontColor },
            margin: { t: 30, b: 100, l: 120, r: 50 },
            xaxis: { side: "top" },
          },
          PLOTLY_CONFIG,
        );
      }

      // --- Table Functions ---
      let tableData = [];
      let currentTableSort = { column: "district", order: "asc" };

      function renderTable(data) {
        tableData = [...data];
        filterAndSortTable();
      }

      function filterAndSortTable() {
        const searchTerm = document
          .getElementById("searchTable")
          .value.toLowerCase();
        const sortBy = document.getElementById("tableSortBy").value;

        let filteredData = tableData.filter((d) =>
          d.district.toLowerCase().includes(searchTerm),
        );

        // Sort data
        filteredData.sort((a, b) => {
          let valA = a[sortBy];
          let valB = b[sortBy];

          if (sortBy === "district") {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
          }

          if (valA < valB) return currentTableSort.order === "asc" ? -1 : 1;
          if (valA > valB) return currentTableSort.order === "asc" ? 1 : -1;
          return 0;
        });

        displayTableData(filteredData);
      }

      function sortTable(column) {
        if (currentTableSort.column === column) {
          currentTableSort.order =
            currentTableSort.order === "asc" ? "desc" : "asc";
        } else {
          currentTableSort.column = column;
          currentTableSort.order = "asc";
        }

        // Update sort icons
        document.querySelectorAll(".sort-header").forEach((header) => {
          header.classList.remove("active");
          const icon = header.querySelector(".sort-icon i");
          icon.className = "fa-solid fa-sort text-gray-400";

          if (header.getAttribute("data-sort") === column) {
            header.classList.add("active");
            icon.classList.remove("text-gray-400");
            icon.classList.add("text-blue-600");
            if (currentTableSort.order === "asc") {
              icon.className = "fa-solid fa-sort-up text-blue-600";
            } else {
              icon.className = "fa-solid fa-sort-down text-blue-600";
            }
          }
        });

        filterAndSortTable();
      }

      function displayTableData(data) {
        const tbody = document.getElementById("dataTableBody");
        tbody.innerHTML = "";

        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500 font-semibold">${currentLanguage === "en" ? "No results found" : "कोई परिणाम नहीं मिला"}</td></tr>`;
          return;
        }

        data.forEach((d) => {
          const tr = document.createElement("tr");
          tr.className =
            "bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700";

          const statusText = d.status;
          const bgColor = RAINFALL_COLORS_HEX[statusText];

          let textColor = "black";
          if (
            statusText === "LARGE EXCESS" ||
            statusText === "DEFICIENT" ||
            statusText === "NORMAL"
          ) {
            textColor = "white";
          }

          const cellStyle = `background-color: ${bgColor}; color: ${textColor};`;

          tr.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">${d.district}</td>
                <td class="px-6 py-4 text-right">${d.actual}</td>
                <td class="px-6 py-4 text-right">${d.normal}</td>
                <td class="px-6 py-4 text-right font-bold">${d.deviation > 0 ? "+" : ""}${d.deviation}%</td>
                <td class="px-6 py-4 text-center font-bold" style="${cellStyle}">
                    <span class="lang-en">${statusText}</span>
                    <span class="lang-hi">${getHindiStatus(statusText)}</span>
                </td>
            `;
          tbody.appendChild(tr);
        });
      }

      function getHindiStatus(status) {
        const statusMap = {
          "LARGE EXCESS": "अत्यधिक अधिक",
          EXCESS: "अधिक",
          NORMAL: "सामान्य",
          DEFICIENT: "कम",
          "LARGE DEFICIENT": "अत्यधिक कम",
          "NO RAIN": "बिना वर्षा",
        };
        return statusMap[status] || status;
      }

      // --- Initialize Dashboard ---

      // --- Initialize Dashboard ---
      document.addEventListener("DOMContentLoaded", () => {
        // 1. साल की लिस्ट (Dropdown) तैयार करें
        if (typeof setupYearDropdown === "function") {
          setupYearDropdown();
        }

        // 2. डिफ़ॉल्ट भाषा हिंदी सेट करें
        document.body.classList.add("hindi");
        currentLanguage = "hi";

        // 3. टॉगल स्विच को इनिशियलाइज़ करें
        const toggle = document.getElementById("langToggle");
        if (toggle) {
          toggle.checked = false; // Default Hindi
        }

        const savedSimple = localStorage.getItem("simpleBackground") === "true";
        if (savedSimple) {
          document.body.classList.add("simple-bg");
        }
        updateBackgroundBtnIcon(savedSimple);

        // 4. मानसून आगमन की CSV फाइल लोड करें
        if (typeof Papa !== "undefined") {
          Papa.parse("Onset and Withdrawal of SW monsoon over Bihar.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
              // ग्लोबल वेरिएबल में डेटा स्टोर करें
              window.monsoonArrivalData = results.data;
              // मुख्य डैशबोर्ड अपडेट करें
              updateDashboard();
            },
            error: function (err) {
              console.error("Monsoon CSV error:", err);
              updateDashboard();
            },
          });
        } else {
          updateDashboard();
        }
      });

      // --- साल को ऑटोमैटिक भरने वाला फंक्शन (Dynamic Year Logic) ---
      function setupYearDropdown() {
        const yearSelect = document.getElementById("yearSelect");
        if (!yearSelect) return;

        const startYear = 2000;
        const currentYear = new Date().getFullYear();
        const endYear = 2025; // भविष्य के लिए बफर

        let yearOptions = "";
        for (let y = endYear; y >= startYear; y--) {
          // जो साल आप पहले दिखाना चाहते हैं (जैसे 2025)
          const selected = y === 2025 ? "selected" : "";
          yearOptions += `<option value="${y}" ${selected}>${y}</option>`;
        }
        yearSelect.innerHTML = yearOptions;
      }
    </script>
    <script src="monsoon-arrival.js"></script>
  </body>
</html>
