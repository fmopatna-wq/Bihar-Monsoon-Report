<!DOCTYPE html>
<html lang="hi" class="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>बिहार मानसून डैशबोर्ड 2025</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    'app-bg': '#F0F9FF', 
                    'dark-app-bg': '#030712', 
                    primary: '#2E8B57',
                    secondary: '#E6F4EA',
                    darkbg: '#1a202c',
                    carddark: '#2d3748',
                }
            }
        }
    }
</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Tiro+Devanagari+Hindi&display=swap');
        
        body { font-family: 'Poppins', 'Tiro Devanagari Hindi', sans-serif; scroll-behavior: smooth; }
        
        .card { 
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .dark .card { border: 1px solid rgba(255,255,255,0.1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }

        .nav-btn {
            @apply px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm hover:bg-green-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all select-none cursor-pointer;
        }

        /* --- NEW: Transparent/Sticky Header Style --- */
        .navbar {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: sticky; 
            top: 0;
            z-index: 50;
        }
        .dark .navbar {
            background-color: rgba(30, 41, 59, 0.9);
        }

        /* --- NEW: Gradient Text Class (For Headers) --- */
        .gradient-text {
            background: linear-gradient(to right, #2563eb, #0d9488); /* Blue to Teal */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-block;
        }
        .dark .gradient-text {
            background: linear-gradient(to right, #60a5fa, #2dd4bf); /* Lighter Blue to Teal for Dark Mode */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* --- NEW: Nav Box Style --- */
        .nav-box {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            color: #4b5563; /* gray-600 */
        }
        .dark .nav-box {
            color: #d1d5db; /* gray-300 */
        }
        
        /* Hover Effect */
        .nav-box:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
            background-color: white;
        }
        .dark .nav-box:hover {
            background-color: #374151;
        }

        /* Active State (Gradient Box) */
        .nav-box.active-nav {
            background: linear-gradient(to right, #2563eb, #0d9488);
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
            border: none;
        }

        /* Responsive Navigation Handling */
        .nav-links-container {
            display: flex;
            gap: 1rem; 
            align-items: center;
        }

        @media (max-width: 1023px) {
            .nav-links-container {
                gap: 0.5rem; 
                overflow-x: auto; 
                white-space: nowrap; 
                padding-bottom: 4px; 
                flex-grow: 1; 
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

<nav id="navbar" class="navbar">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
        
        <div class="flex items-center gap-3 nav-logo shrink-0">
            <img src="assets/logo.png" alt="IMD Logo" class="h-8 w-8 object-contain dark:invert"/> 
            <div>
                <h1 class="text-xl font-bold leading-tight gradient-text">बिहार मानसून डैशबोर्ड</h1>
                <div class="text-xs text-gray-500 dark:text-gray-400">IMD MC Patna — व्यापक विश्लेषण</div>
            </div>
        </div>
        
        <div class="flex nav-links-container text-sm font-semibold mx-4 lg:mx-0 py-2 lg:py-0">
            <a href="index.html" class="nav-box active-nav" onclick="setActive(this)">होम</a>
            <a href="index.html#analysis" class="nav-box" onclick="setActive(this)">डैशबोर्ड</a>    
            <a href="district.html" class="nav-box" onclick="setActive(this)">जिलावार</a> 
            <a href="maps.html" class="nav-box" onclick="setActive(this)">मानचित्र</a>
            <a href="history.html" class="nav-box" onclick="setActive(this)">ऐतिहासिक</a>
        </div>

        <div class="flex items-center gap-4 shrink-0">
            <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i class="fa-solid fa-moon dark:hidden text-gray-600"></i>
                <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
            </button>
        </div>
    </div>
</nav>

<main class="max-w-7xl mx-auto p-4 md:p-6 space-y-8">

    <header id="overview" class="text-center py-6 space-y-4">
        <h2 class="text-3xl md:text-4xl font-bold">
            <span class="gradient-text">बिहार मानसून विश्लेषण <span id="yearDisplay">2025</span></span>
        </h2>
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm inline-flex flex-col md:flex-row items-center gap-6 mx-auto border border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-2">
                <label class="text-sm font-semibold text-gray-500">वर्ष:</label>
                <select id="yearSelect" onchange="updateDashboard()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-1.5 focus:ring-2 focus:ring-blue-500 font-bold">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                </select>
            </div>
            <div class="h-8 w-px bg-gray-300 dark:bg-gray-600 hidden md:block"></div>
            <div class="flex items-center gap-4">
                <label class="text-sm font-semibold text-gray-500">अवधि:</label>
                <select id="periodSelect" onchange="updateDashboard()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-1.5 focus:ring-2 focus:ring-blue-500 font-bold w-32">
                    <option value="overall_monsoon" selected>कुल (Overall)</option>
                    <option value="september">सितंबर</option>
                    <option value="august">अगस्त</option>
                    <option value="july">जुलाई</option>
                    <option value="june">जून</option>
                </select>
            </div>
            </div>
        <div class="flex justify-center items-center gap-4 text-sm font-medium text-gray-500 dark:text-gray-400 mt-2">
            <span><i class="fa-solid fa-map-location-dot"></i> कुल जिले: 38</span>
        </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
            <div class="text-blue-600 dark:text-blue-400 text-3xl mb-2"><i class="fa-solid fa-droplet"></i></div>
            <div class="text-3xl font-bold gradient-text" id="statAvgRain">--</div>
            <div class="text-sm text-gray-500 mt-1">औसत वर्षा (मिमी)</div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
            <div id="statIconDev" class="text-3xl mb-2"><i class="fa-solid fa-chart-line"></i></div>
            <div class="text-3xl font-bold" id="statAvgDev">--</div>
            <div class="text-sm text-gray-500 mt-1" id="statDevLabel">विचलन</div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
            <div class="text-orange-500 text-3xl mb-2"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <div class="text-3xl font-bold gradient-text" id="statDeficitCount">--</div>
            <div class="text-sm text-gray-500 mt-1">घाटा जिले</div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-6 rounded-xl">
            <div class="text-teal-600 dark:text-teal-400 text-3xl mb-2"><i class="fa-solid fa-trophy"></i></div>
            <div class="text-xl font-bold truncate gradient-text" id="statMaxDist">--</div>
            <div class="text-sm font-bold text-gray-600 dark:text-gray-300" id="statMaxVal">--</div>
        </div>
    </section>

    <section id="analysis" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm lg:col-span-3">
            <h3 class="text-lg font-bold flex items-center gap-2 mb-2">
                <i class="fa-solid fa-chart-column text-blue-600"></i> 
                <span class="gradient-text">जिलेवार वर्षा विचलन (<span id="monthDisplay" class="dynamic-month-label">कुल (Overall)</span>)</span>
            </h3>
            <div id="deviationChart" class="w-full h-[500px]"></div>
        </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-chart-area text-blue-600"></i> 
                <span class="gradient-text">वर्षा प्रवृत्ति / तुलना</span>
            </h3>
            <div id="lineChart" class="w-full h-[400px]">
                <div class="text-center p-8 text-gray-500">
                    
                </div>
            </div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-chart-pie text-orange-600"></i> 
                <span class="gradient-text">प्रदर्शन वर्गीकरण</span>
            </h3>
            <div id="pieChart" class="w-full h-[400px]"></div>
        </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-1 gap-6">
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-list-ol text-purple-600"></i> 
                <span class="gradient-text">टॉप 5 और बॉटम 5 जिले</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="topDistChart" class="h-[400px]"></div>
                <div id="botDistChart" class="h-[400px]"></div>
            </div>
        </div>
        <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-table-cells text-teal-600"></i> 
                <span class="gradient-text">वर्षा वितरण मैट्रिक्स (Heatmap)</span>
            </h3>
            <div id="heatmapChart" class="w-full h-[600px]">
                <div class="text-center p-8 text-gray-500">
                    
                </div>
            </div>
        </div>
    </section>
    
    <section id="maps-section" class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm text-center">
        <div class="border-b border-gray-100 dark:border-gray-700 pb-4 mb-4">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-map text-teal-600"></i> 
                <span class="gradient-text">भौगोलिक मानचित्र विश्लेषण</span>
            </h3>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">मासिक और समग्र वर्षा वितरण मानचित्र देखने के लिए अलग पृष्ठ पर जाएँ।</p>
        </div>
        <a href="maps.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-gradient-to-r from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
            <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i> मानचित्र पृष्ठ खोलें
        </a>
    </section>
    
    <section id="data-table" class="card bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm">
        <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">विस्तृत डेटा: <span id="tableMonthLabel" class="dynamic-month-label text-blue-600">कुल (Overall)</span></h3>
             <a href="district.html" class="text-sm text-blue-500 dark:text-blue-400 hover:underline mt-1 block">
                 <i class="fa-solid fa-table-list mr-1"></i> जिलावार सर्च और सॉर्टिंग के लिए यहाँ क्लिक करें।
            </a>
        </div>
        <div class="overflow-x-auto max-h-[500px]">
            <table class="w-full text-sm text-left text-gray-600 dark:text-gray-300">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-900 dark:text-gray-300 sticky top-0 z-10">
                    <tr>
                        <th class="px-6 py-3">जिला</th>
                        <th class="px-6 py-3 text-right">वास्तविक (मिमी)</th>
                        <th class="px-6 py-3 text-right">सामान्य (मिमी)</th>
                        <th class="px-6 py-3 text-right">विचलन (%)</th>
                        <th class="px-6 py-3 text-center">स्थिति</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody" class="divide-y divide-gray-100 dark:divide-gray-700">
                    </tbody>
            </table>
        </div>
    </section>

    <footer class="bg-slate-800 text-white p-8 rounded-xl mt-8 text-center space-y-4">
        <h4 class="text-xl font-bold gradient-text">डेटा स्रोत और क्रेडिट</h4>
        <p class="text-gray-300">India Meteorological Department: Meteorological Centre Patna</p>
        <div class="pt-4 border-t border-slate-700">
            <p class="text-sm text-gray-400">विश्लेषण तैयार किया गया:</p>
            <p class="text-lg font-semibold">© Lal Kamal</p>
        </div>
    </footer>

</main>

<script>
    // --- UI Logic: Active Tab Switching ---
    function setActive(element) {
        document.querySelectorAll('.nav-box').forEach(el => el.classList.remove('active-nav'));
        element.classList.add('active-nav');
    }

    function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        // डार्क मोड टॉगल होने पर चार्ट को री-रेंडर करें
        const periodKey = document.getElementById('periodSelect').value;
        if (window.globalData) {
            updateDashboardUI(window.globalData);
        } else {
             updateDashboard();
        }
        // मासिक चार्ट को भी री-रेंडर करें, periodKey के साथ
        if (window.globalMonthlyData) {
            renderMonthlyCharts(window.globalMonthlyData, periodKey);
        }
    }

    // --- Data Mapping ---
    const monthDisplayNames = {
        'overall_monsoon': 'कुल (Overall)',
        'september': 'सितंबर',
        'august': 'अगस्त',
        'july': 'जुलाई',
        'june': 'जून'
    };
    
    // वैश्विक वैरिएबल (Global Variable) जो लोड किए गए CSV डेटा को रखेगा
    window.globalData = []; // Single CSV data (e.g., june.csv)
    window.globalMonthlyData = []; // Combined Monthly CSV data (monthly_combined.csv)

    /**
     * CSV फ़ाइल को फ़ेच करता है और Papa Parse का उपयोग करके उसे JSON Array में पार्स करता है।
     */
    async function loadCSVData(year, periodKey) {
        const filePath = `data/${year}/${periodKey}.csv`; 

        try {
            console.log(`Fetching data from: ${filePath}`);
            
            const response = await fetch(filePath);
            
            if (!response.ok) {
                if (periodKey === 'monthly_combined') {
                    throw new Error(`मासिक संयुक्त डेटा फ़ाइल नहीं मिली: ${filePath}`);
                }
                throw new Error(`डेटा फ़ाइल नहीं मिली: ${filePath}`);
            }
            
            const csvText = await response.text();
            
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true, 
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length) {
                            console.error("Papa Parse त्रुटियाँ:", results.errors);
                            reject(new Error("CSV पार्सिंग विफल रही।"));
                            return;
                        }
                        console.log(`Successfully loaded ${results.data.length} records for ${periodKey}.`);
                        resolve(results.data);
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });

        } catch (error) {
            console.error(`CSV लोड करने में विफलता (${periodKey}):`, error);
            throw error;
        }
    }

    /**
     * कच्चे सिंगल-मंथ CSV डेटा को विज़ुअलाइज़ेशन के लिए आवश्यक फ़ॉर्मेट में प्रोसेस करता है।
     */
    function getProcessedData(rawData) {
        return rawData.map(d => {
            const actualStr = d['Actual R/F (mm)'];
            const normalStr = d['Normal R/F (mm)'];
            const deviationStr = d['Departure']; 

            const actual = parseFloat(actualStr);
            const normal = parseFloat(normalStr);
            const deviation = parseInt(deviationStr);
            
            return {
                district: d['DISTRICT NAME'] ? d['DISTRICT NAME'].trim() : 'Unknown', 
                actual: isNaN(actual) ? 0 : actual, 
                normal: isNaN(normal) ? 0 : normal, 
                deviation: isNaN(deviation) ? 0 : deviation,
            };
        });
    }

    /**
     * कच्चे मासिक संयुक्त CSV डेटा को प्रोसेस करता है (Line Chart और Heatmap के लिए)
     */
    function getProcessedMonthlyData(rawData) {
        return rawData.map(d => {
            const actual = parseFloat(d['Actual R/F (mm)']) || 0;
            const normal = parseFloat(d['Normal R/F (mm)']) || 0;
            const deviation = parseInt(d['Departure']) || 0;
            
            return {
                district: d['DISTRICT NAME'] ? d['DISTRICT NAME'].trim() : 'Unknown',
                month: d['MONTH'] ? d['MONTH'].trim() : 'Unknown',
                actual: actual,
                normal: normal,
                deviation: deviation,
            };
        });
    }

    // --- Dashboard Control ---

    /**
     * ड्रॉपडाउन चयन के आधार पर डेटा को लोड और UI को अपडेट करता है।
     */
    async function updateDashboard() {
        const year = document.getElementById('yearSelect').value;
        const periodKey = document.getElementById('periodSelect').value;
        const monthLabel = monthDisplayNames[periodKey] || periodKey;
        
        // UI लेबल अपडेट करें
        document.getElementById('yearDisplay').innerText = year;
        document.getElementById('monthDisplay').innerText = monthLabel;
        document.getElementById('tableMonthLabel').innerText = monthLabel;
        document.querySelectorAll('.dynamic-month-label').forEach(el => el.innerText = monthLabel);
        
        // 1. सिंगल CSV डेटा लोड करें (Stats, Bar, Pie, Table के लिए)
        try {
            const rawData = await loadCSVData(year, periodKey);
            window.globalData = rawData; 
            updateDashboardUI(rawData);
        } catch (error) {
            console.error("सिंगल डैशबोर्ड अपडेट में त्रुटि:", error);
            document.getElementById('dataTableBody').innerHTML = 
                `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500 font-semibold">
                    डेटा लोड नहीं हो सका। कृपया सुनिश्चित करें कि फ़ाइल ${year}/${periodKey}.csv मौजूद है।
                </td></tr>`;
            renderStats([]); 
        }

        // 2. मासिक संयुक्त डेटा लोड करें (Line Chart और Heatmap के लिए)
        loadAndRenderMonthlyCharts(year, periodKey); 
    }
    
    /**
     * मासिक संयुक्त डेटा लोड करता है और Line/Heatmap चार्ट रेंडर करता है।
     */
    async function loadAndRenderMonthlyCharts(year, selectedPeriodKey) { 
        try {
            const rawMonthlyData = await loadCSVData(year, 'monthly_combined');
            window.globalMonthlyData = getProcessedMonthlyData(rawMonthlyData);
            renderMonthlyCharts(window.globalMonthlyData, selectedPeriodKey); 
        } catch (error) {
            console.error("Monthly combined data load failed:", error);
            // संदेश हटाने के लिए: Line Chart और Heatmap दोनों को साफ़ किया गया
            document.getElementById('lineChart').innerHTML = '';
            document.getElementById('heatmapChart').innerHTML = '';
            Plotly.purge('lineChart');
            Plotly.purge('heatmapChart');
        }
    }
    
    /**
     * मासिक डेटा का उपयोग करके Line Chart और Heatmap को रेंडर करता है।
     */
    function renderMonthlyCharts(data, selectedPeriodKey) { 
        if (data && data.length > 0) {
            // Line Chart: पूरे डेटा पर मासिक औसत दिखाएगा
            renderLineChart(data);
            
            // Heatmap: periodKey के आधार पर फ़िल्टर किया जाएगा
            renderHeatmap(data, selectedPeriodKey); 
        }
    }

    /**
     * संसाधित डेटा का उपयोग करके सभी मुख्य UI तत्वों को अपडेट करता है।
     */
    function updateDashboardUI(rawData) {
        const processedData = getProcessedData(rawData);
        
        renderStats(processedData);
        renderMainCharts(processedData);
        renderTable(processedData);
    }
    
    // --- Render Logic ---
    
    function renderStats(data) {
        if (data.length === 0) {
            document.getElementById('statAvgRain').innerText = '--';
            document.getElementById('statAvgDev').innerText = '--';
            document.getElementById('statDeficitCount').innerText = '--';
            document.getElementById('statMaxDist').innerText = '--';
            document.getElementById('statMaxVal').innerText = '--';
            return;
        }

        const totalActual = data.reduce((sum, d) => sum + d.actual, 0);
        const totalNormal = data.reduce((sum, d) => sum + d.normal, 0);
        const avgActual = (totalActual / data.length).toFixed(1);
        
        let avgDev = 0;
        if (totalNormal > 0) {
            avgDev = Math.round(((totalActual - totalNormal) / totalNormal) * 100);
        }
        
        const deficitCount = data.filter(d => d.deviation < 0).length;
        const maxDist = data.reduce((prev, current) => (prev.actual > current.actual) ? prev : current);

        document.getElementById('statAvgRain').innerText = `${avgActual} मिमी`;
        const devElem = document.getElementById('statAvgDev');
        devElem.innerText = `${avgDev}%`;
        
        let colorClass = 'text-gray-600';
        let iconClass = 'text-gray-500';
        let labelText = 'विचलन';
        if (avgDev < 0) {
            colorClass = 'text-red-600';
            iconClass = 'text-red-500';
            labelText = 'सामान्य से कम';
        } else if (avgDev > 0) {
            colorClass = 'text-green-600';
            iconClass = 'text-green-500';
            labelText = 'सामान्य/अधिक';
        }
        
        devElem.className = `text-3xl font-bold ${colorClass}`;
        document.getElementById('statIconDev').className = `text-3xl mb-2 ${iconClass}`;
        document.getElementById('statDevLabel').innerText = labelText;
        
        document.getElementById('statDeficitCount').innerText = deficitCount;
        document.getElementById('statMaxDist').innerText = maxDist.district;
        document.getElementById('statMaxVal').innerText = `${maxDist.actual} मिमी`;
    }

    function renderMainCharts(data) {
        if (data.length === 0) {
            Plotly.purge('deviationChart'); 
            Plotly.purge('pieChart'); 
            Plotly.purge('topDistChart'); 
            Plotly.purge('botDistChart'); 
            return;
        }
        
        const isDark = document.documentElement.classList.contains('dark');
        const fontColor = isDark ? '#cbd5e1' : '#334155';
        
        const layoutConfig = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Poppins', color: fontColor },
            margin: { t: 30, b: 60, l: 40, r: 10 },
            xaxis: { showgrid: false },
            yaxis: { showgrid: true, gridcolor: isDark ? '#374151' : '#e2e8f0' }
        };

        // --- 1. Deviation Chart (Bar) ---
        const colors = data.map(d => d.deviation >= 0 ? '#10b981' : (d.deviation > -20 ? '#f59e0b' : '#ef4444'));
        Plotly.newPlot('deviationChart', [{
            x: data.map(d => d.district), y: data.map(d => d.deviation),
            type: 'bar', marker: { color: colors }, hovertemplate: '<b>%{x}</b><br>विचलन: %{y}%<extra></extra>'
        }], { ...layoutConfig, yaxis: { title: 'विचलन (%)' }, dragmode: 'pan' }, {responsive: true, displayModeBar: false});

        // --- 2. Top/Bottom Charts ---
        const sorted = [...data].sort((a,b) => b.actual - a.actual);
        const top5 = sorted.slice(0, 5).reverse();
        const bot5 = sorted.slice(-5);
        
        const barLayout = { 
            ...layoutConfig, 
            margin: {l: 80, t: 10, b: 30, r: 10}, 
            xaxis: { title: 'वास्तविक वर्षा (मिमी)'} 
        };
        
        Plotly.newPlot('topDistChart', [{
            y: top5.map(d => d.district), x: top5.map(d => d.actual),
            type: 'bar', orientation: 'h', marker: { color: '#059669' },
            hovertemplate: '<b>%{y}</b>: %{x} मिमी<extra>टॉप 5</extra>'
        }], barLayout, {responsive: true, displayModeBar: false});
        
        Plotly.newPlot('botDistChart', [{
            y: bot5.map(d => d.district), x: bot5.map(d => d.actual),
            type: 'bar', orientation: 'h', marker: { color: '#ea580c' },
            hovertemplate: '<b>%{y}</b>: %{x} मिमी<extra>बॉटम 5</extra>'
        }], barLayout, {responsive: true, displayModeBar: false});

        // --- 3. Pie Chart (वर्गीकरण) ---
        const counts = { excess: 0, normal: 0, deficit: 0, largeDef: 0 };
        data.forEach(d => {
            if(d.deviation > 19) counts.excess++;
            else if(d.deviation >= -19) counts.normal++;
            else if(d.deviation >= -59) counts.deficit++;
            else counts.largeDef++;
        });
        
        const pieValues = [counts.excess, counts.normal, counts.deficit, counts.largeDef].filter(v => v > 0);
        const pieLabels = ['अधिक (+20% से अधिक)', 'सामान्य (-19% से +19%)', 'घाटा (-20% से -59%)', 'गंभीर घाटा (-60% से कम)'].filter((_, i) => [counts.excess, counts.normal, counts.deficit, counts.largeDef][i] > 0);
        
        Plotly.newPlot('pieChart', [{
            values: pieValues,
            labels: pieLabels,
            type: 'pie', hole: 0.5, 
            marker: { colors: ['#10b981', '#3b82f6', '#f59e0b', '#dc2626'] }
        }], { ...layoutConfig, showlegend: true, legend: { orientation: 'h', y: -0.1 } }, {responsive: true});
    }

    // --- Line Chart (वर्षा प्रवृत्ति) ---
    function renderLineChart(data) {
        const monthlyAverages = {};
        const monthOrder = ['June', 'July', 'August', 'September'];
        
        data.forEach(d => {
            if (!monthlyAverages[d.month]) {
                monthlyAverages[d.month] = { totalActual: 0, totalNormal: 0, count: 0 };
            }
            monthlyAverages[d.month].totalActual += d.actual;
            monthlyAverages[d.month].totalNormal += d.normal;
            monthlyAverages[d.month].count++;
        });

        const plotMonths = monthOrder.filter(m => monthlyAverages[m]);
        const avgActuals = plotMonths.map(m => (monthlyAverages[m].totalActual / monthlyAverages[m].count).toFixed(1));
        const avgNormals = plotMonths.map(m => (monthlyAverages[m].totalNormal / monthlyAverages[m].count).toFixed(1));

        const isDark = document.documentElement.classList.contains('dark');
        const fontColor = isDark ? '#cbd5e1' : '#334155';
        
        Plotly.newPlot('lineChart', [
            {
                x: plotMonths, y: avgActuals,
                mode: 'lines+markers', name: 'वास्तविक औसत',
                line: { color: '#2563eb', width: 3 },
                marker: { size: 8 }
            },
            {
                x: plotMonths, y: avgNormals,
                mode: 'lines+markers', name: 'सामान्य औसत',
                line: { color: '#0d9488', dash: 'dash', width: 2 },
                marker: { size: 6 }
            }
        ], {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Poppins', color: fontColor },
            margin: { t: 30, b: 60, l: 40, r: 10 },
            title: { text: 'मासिक वर्षा प्रवृत्ति (क्षेत्रीय औसत)', font: { size: 16 } },
            xaxis: { title: 'महीना', showgrid: false },
            yaxis: { title: 'वर्षा (मिमी)', showgrid: true, gridcolor: isDark ? '#374151' : '#e2e8f0' },
            // **Legend को बॉटम में रखा गया है (y: -0.2)**
            legend: { orientation: 'h', y: -0.2 } 
        }, { responsive: true, displayModeBar: false });
    }

    // --- Heatmap Chart (वर्षा वितरण) ---
    function renderHeatmap(data, selectedPeriodKey) {
        const isDark = document.documentElement.classList.contains('dark');
        const fontColor = isDark ? '#cbd5e1' : '#334155';
        
        const allMonthsOrder = ['June', 'July', 'August', 'September'];
        let monthsToShow = allMonthsOrder;

        if (allMonthsOrder.map(m => m.toLowerCase()).includes(selectedPeriodKey.toLowerCase())) {
            const capitalizedMonth = selectedPeriodKey.charAt(0).toUpperCase() + selectedPeriodKey.slice(1).toLowerCase();
            monthsToShow = [capitalizedMonth];
        } 
        
        const districtNames = Array.from(new Set(data.map(d => d.district))).sort();
        const deviationMatrix = [];

        districtNames.forEach(district => {
            const row = [];
            monthsToShow.forEach(month => {
                const record = data.find(d => d.district === district && d.month === month);
                row.push(record ? record.deviation : null); 
            });
            deviationMatrix.push(row);
        });

        const colorscale = [
            [0.0, '#b91c1c'], 
            [0.4, '#f87171'], 
            [0.6, '#fde047'], 
            [0.8, '#4ade80'], 
            [1.0, '#16a34a']  
        ];
        
        Plotly.newPlot('heatmapChart', [{
            z: deviationMatrix, 
            x: monthsToShow, 
            y: districtNames,
            type: 'heatmap',
            colorscale: colorscale,
            zmin: -100, 
            zmax: 100,
            colorbar: {
                title: 'विचलन (%)',
                titleside: 'right',
                tickvals: [-80, -40, 0, 40, 80],
                ticktext: ['गंभीर घाटा', 'घाटा', 'सामान्य', 'अधिक', 'बहुत अधिक'],
                yanchor: 'middle',
                y: 0.5,
            },
            hovertemplate: 'जिला: %{y}<br>महीना: %{x}<br>विचलन: %{z}%<extra></extra>'
        }], {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Poppins', color: fontColor },
            // **टॉप मार्जिन 70px किया गया है**
            margin: { t: 70, b: 60, l: 100, r: 10 }, 
            title: { text: 'मासिक विचलन Heatmap (जिलावार)', font: { size: 16 } },
            xaxis: { side: 'top', tickangle: -45, showgrid: false },
            yaxis: { automargin: true, tickangle: 0, showgrid: false }
        }, { responsive: true, displayModeBar: false });
    }

    function renderTable(data) {
        const tbody = document.getElementById('dataTableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
             tbody.innerHTML = 
                `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">इस चयन के लिए कोई डेटा नहीं मिला।</td></tr>`;
            return;
        }

        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.className = "bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition";
            
            const absDev = Math.abs(d.deviation);
            const width = Math.min(absDev + 20, 100); 
            
            const colorClass = d.deviation < 0 ? 'bg-red-500' : 'bg-green-500';
            const textClass = d.deviation < 0 ? 'text-red-600' : 'text-green-600';
            
            tr.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${d.district}</td>
                <td class="px-6 py-4 text-right">${d.actual.toFixed(1)}</td>
                <td class="px-6 py-4 text-right">${d.normal}</td>
                <td class="px-6 py-4 text-right font-bold ${textClass}">${d.deviation}%</td>
                <td class="px-6 py-4">
                    <div class="h-2 w-full rounded-full bg-gray-200 dark:bg-gray-600 overflow-hidden">
                        <div class="${colorClass} h-full" style="width: ${width}%"></div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Init (आरंभ करना)
    document.addEventListener('DOMContentLoaded', () => {
        updateDashboard(); 
    });
</script>
</body>
</html>